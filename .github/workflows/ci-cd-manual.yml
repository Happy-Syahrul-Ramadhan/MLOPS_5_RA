name: CI/CD - Manual Deployment

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Job 1: Test & Quality Check
  test:
    name: Test & Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r deployment/requirements.txt
        pip install pytest flake8 black
    
    - name: Code Quality - Flake8
      run: |
        echo "Running Flake8 linter..."
        flake8 deployment/ mlops/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        flake8 deployment/ mlops/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: Code Format - Black
      run: |
        echo "Checking code formatting..."
        black --check deployment/ mlops/ || true
      continue-on-error: true
    
    - name: Import Tests
      run: |
        echo "Testing imports..."
        cd deployment
        python -c "import sys; sys.path.append('.'); sys.path.append('../mlops'); from app_mlops import app; print('Flask app imported successfully')"
        cd ..
        python -c "from mlops.monitoring.performance import PerformanceMonitor; print('Performance monitor OK')"
        python -c "from mlops.monitoring.drift_detection import DataDriftDetector; print('Drift detector OK')"
        python -c "from mlops.mlflow_config.config import mlflow_config; print('MLflow config OK')"
    
    - name: Check Required Files
      run: |
        echo "Checking required files..."
        test -f deployment/app_mlops.py && echo "app_mlops.py exists" || exit 1
        test -f model/model.pkl && echo "model.pkl exists" || exit 1
        test -f data/WA_Fn-UseC_-Telco-Customer-Churn.csv && echo "Training data exists" || exit 1
        test -f deployment/requirements.txt && echo "requirements.txt exists" || exit 1
        echo "All required files present"
    
    - name: Test Summary
      run: |
        echo "‚úÖ All tests passed!"
  
  # Job 2: Build Artifact
  build:
    name: Build Application Package
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create deployment package
      run: |
        echo "Creating deployment package..."
        mkdir -p dist
        
        # Copy necessary files
        cp -r deployment dist/
        cp -r mlops dist/
        cp -r model dist/
        cp -r data dist/
        cp -r training dist/
        
        # Create version file
        echo "version: $(date +%Y%m%d-%H%M%S)" > dist/VERSION
        echo "commit: ${{ github.sha }}" >> dist/VERSION
        echo "branch: ${{ github.ref_name }}" >> dist/VERSION
        
        # Create archive
        cd dist
        tar -czf ../mlops-app-${{ github.sha }}.tar.gz .
        cd ..
        
        echo "Package created: mlops-app-${{ github.sha }}.tar.gz"
        ls -lh mlops-app-*.tar.gz
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: mlops-app-${{ github.sha }}
        path: mlops-app-${{ github.sha }}.tar.gz
        retention-days: 30
    
    - name: Build Summary
      run: |
        echo "Build complete!"
        echo "Artifact: mlops-app-${{ github.sha }}.tar.gz"
  
  # Job 3: Deploy to Server (Manual/SSH)
  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v3
      with:
        name: mlops-app-${{ github.sha }}
    
    - name: Deploy Instructions
      run: |
        echo "üöÄ Deployment Package Ready!"
        echo ""
        echo "üì¶ Artifact: mlops-app-${{ github.sha }}.tar.gz"
        echo ""
        echo "üìã Manual Deployment Steps:"
        echo ""
        echo "1. Download artifact dari GitHub Actions"
        echo "2. Upload ke server:"
        echo "   scp mlops-app-*.tar.gz user@your-server:/app/"
        echo ""
        echo "3. Extract di server:"
        echo "   cd /app"
        echo "   tar -xzf mlops-app-*.tar.gz"
        echo ""
        echo "4. Install dependencies:"
        echo "   cd /app/deployment"
        echo "   pip install -r requirements.txt"
        echo ""
        echo "5. Restart aplikasi:"
        echo "   pkill -f app_mlops.py"
        echo "   nohup python app_mlops.py > app.log 2>&1 &"
        echo ""
        echo "6. Verify:"
        echo "   curl http://your-server:5000/api/health"
        echo ""
  
  # Job 4: Notification
  notify:
    name: Notification
    needs: [test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Success Notification
      if: ${{ needs.test.result == 'success' && needs.build.result == 'success' }}
      run: |
        echo "‚úÖ CI/CD Pipeline Completed Successfully!"
        echo "================================"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "================================"
        echo ""
        echo "üì¶ Artifact available for download"
        echo "üöÄ Ready for deployment"
    
    - name: Failure Notification
      if: ${{ needs.test.result == 'failure' || needs.build.result == 'failure' }}
      run: |
        echo "‚ùå CI/CD Pipeline Failed!"
        echo "================================"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Please check the logs above"
        echo "================================"
        exit 1
